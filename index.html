<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muddled Marketplace - Level 1</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #87CEEB;
            font-family: 'Arial Rounded MT Bold', 'Helvetica', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #game-ui {
            position: absolute;
            top: 0;
            width: 100%;
            height: 180px;
            background: linear-gradient(to bottom, #5d4037, #8d6e63);
            border-bottom: 8px solid #3e2723;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .stats-bar {
            position: absolute;
            top: 10px;
            right: 20px;
            background: #f1c40f;
            padding: 5px 20px;
            border-radius: 50px;
            border: 3px solid #f39c12;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sentence-display {
            color: #fff;
            font-size: 1.8rem;
            text-align: center;
            padding: 0 20px;
            line-height: 1.4;
        }
        .muddled-word {
            background: #e67e22;
            padding: 2px 12px;
            border-radius: 8px;
            color: white;
            display: inline-block;
            margin: 0 5px;
            box-shadow: 0 3px 0 #d35400;
        }
        canvas {
            display: block;
            background: linear-gradient(#87CEEB 0%, #87CEEB 60%, #2ecc71 60%, #2ecc71 100%);
        }
    </style>
</head>
<body>

<div id="game-ui">
    <div class="stats-bar">
        <span>üí∞ Coins: <span id="coin-count">0</span></span>
    </div>
    <div id="msg" style="color: #ffeb3b; font-size: 1rem; margin-bottom: 5px;">FIX THE SHOP SIGN!</div>
    <div class="sentence-display" id="sentence-container">
        Loading...
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const coinEl = document.getElementById('coin-count');
    const sentenceContainer = document.getElementById('sentence-container');
    const msgEl = document.getElementById('msg');

    const levelData = [
        { scrambled: "HCOLOS", target: "SCHOOL", sentence: "The _____ bus was late." },
        { scrambled: "BEZAR", target: "ZEBRA", sentence: "A _____ is an animal with stripes." },
        { scrambled: "KOBO", target: "BOOK", sentence: "I have lost my _____." },
        { scrambled: "NEPICL", target: "PENCIL", sentence: "Where is my _____?" },
        { scrambled: "YRATP", target: "PARTY", sentence: "What time is the _____?" },
        { scrambled: "RETES", target: "TREES", sentence: "I have big _____ in my garden." },
        { scrambled: "TCNHEIK", target: "KITCHEN", sentence: "She went to the _____." },
        { scrambled: "ITOANTS", target: "STATION", sentence: "We had to be at the _____ by six." },
        { scrambled: "MENTIU", target: "MINUTE", sentence: "The last _____ of the game." },
        { scrambled: "ZIAMANEG", target: "MAGAZINE", sentence: "Dad read the _____ before bed." },
        { scrambled: "NOBLALO", target: "BALLOON", sentence: "The _____ floated into the sky." },
        { scrambled: "DOGBELB", target: "GOBBLED", sentence: "He _____ the pudding greedily." },
        { scrambled: "PLAYHIP", target: "HAPPILY", sentence: "Living _____ ever after." },
        { scrambled: "SEALPIC", target: "SPECIAL", sentence: "There is a _____ offer." },
        { scrambled: "CGTNHIILO", target: "CLOTHING", sentence: "Astronauts wear special _____." }
    ];

    let currentLevel = 0;
    let totalCoins = 0;
    let tiles = [];
    let slots = [];
    let userInput = "";
    let particles = [];
    let audioCtx = null;

    // Simple Sound Generator
    function playSound(type) {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        if (type === 'correct') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(500, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.2);
        } else if (type === 'wrong') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        } else if (type === 'coin') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1760, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.2);
        }
    }

    class Tile {
        constructor(char, x, y) {
            this.char = char;
            this.x = x;
            this.y = y;
            this.w = 70;
            this.h = 70;
            this.isClicked = false;
            this.color = `hsl(${Math.random() * 40 + 20}, 80%, 60%)`;
        }

        draw() {
            if (this.isClicked) return;
            ctx.save();
            ctx.shadowBlur = 15;
            ctx.shadowColor = "rgba(0,0,0,0.2)";
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.roundRect(this.x - this.w/2, this.y - this.h/2, this.w, this.h, 12);
            ctx.fill();
            ctx.strokeStyle = "rgba(255,255,255,0.8)";
            ctx.lineWidth = 4;
            ctx.stroke();
            
            ctx.fillStyle = "white";
            ctx.font = "bold 36px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(this.char, this.x, this.y);
            ctx.restore();
        }

        contains(mx, my) {
            return mx > this.x - this.w/2 && mx < this.x + this.w/2 && 
                   my > this.y - this.h/2 && my < this.y + this.h/2;
        }
    }

    function initLevel() {
        userInput = "";
        tiles = [];
        slots = [];
        const data = levelData[currentLevel];
        
        // Setup UI
        sentenceContainer.innerHTML = data.sentence.replace("_____", `<span class="muddled-word">${data.scrambled}</span>`);
        msgEl.innerText = `SHOP ${currentLevel + 1} / 15`;

        // Create letter tiles (shuffled)
        let chars = data.scrambled.split('');
        const startX = (canvas.width / 2) - ((chars.length - 1) * 45);
        
        chars.forEach((c, i) => {
            tiles.push(new Tile(c, startX + (i * 90), canvas.height * 0.75));
            slots.push({ x: startX + (i * 90), y: canvas.height * 0.42 });
        });
    }

    function createParticles(x, y, color = "gold") {
        for(let i=0; i<12; i++) {
            particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 12,
                vy: (Math.random() - 0.5) * 12,
                life: 1.0,
                color: color === "gold" ? "#f1c40f" : "#e74c3c"
            });
        }
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Ground and decorative road
        ctx.fillStyle = "#95a5a6";
        ctx.fillRect(0, canvas.height * 0.35, canvas.width, 150);

        // Signboard
        ctx.fillStyle = "#ecf0f1";
        ctx.fillRect(canvas.width/2 - 320, canvas.height * 0.38, 640, 80);
        ctx.strokeStyle = "#7e5109";
        ctx.lineWidth = 8;
        ctx.strokeRect(canvas.width/2 - 320, canvas.height * 0.38, 640, 80);

        // Target Slots
        slots.forEach((slot, i) => {
            ctx.fillStyle = "rgba(0,0,0,0.1)";
            ctx.fillRect(slot.x - 30, slot.y - 30, 60, 60);
            if (userInput[i]) {
                ctx.fillStyle = "#2c3e50";
                ctx.font = "bold 44px Arial";
                ctx.textAlign = "center";
                ctx.fillText(userInput[i], slot.x, slot.y + 15);
            }
        });

        tiles.forEach(t => t.draw());

        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.life -= 0.02;
            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, 4, 0, Math.PI*2);
            ctx.fill();
            if (p.life <= 0) particles.splice(i, 1);
        });
        ctx.globalAlpha = 1.0;

        requestAnimationFrame(draw);
    }

    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;

        tiles.forEach(t => {
            if (!t.isClicked && t.contains(mx, my)) {
                const targetChar = levelData[currentLevel].target[userInput.length];
                if (t.char === targetChar) {
                    playSound('correct');
                    t.isClicked = true;
                    userInput += t.char;
                    createParticles(t.x, t.y, "gold");
                    
                    if (userInput === levelData[currentLevel].target) {
                        totalCoins += 100;
                        coinEl.innerText = totalCoins;
                        playSound('coin');
                        setTimeout(() => {
                            currentLevel++;
                            if (currentLevel < levelData.length) {
                                initLevel();
                            } else {
                                const tvTime = Math.floor(totalCoins / 100);
                                document.body.innerHTML = `
                                    <div style="text-align:center; padding-top:100px;">
                                        <h1>üèÜ Marketplace Restored!</h1>
                                        <h2>Total Coins: ${totalCoins}</h2>
                                        <div style="font-size: 2rem; background: #f1c40f; padding: 20px; border-radius: 20px; display: inline-block;">
                                            üì∫ You earned ${tvTime} minutes of TV Time!
                                        </div>
                                        <p>Ready for Level 2: The Safari?</p>
                                    </div>
                                `;
                            }
                        }, 800);
                    }
                } else {
                    playSound('wrong');
                    createParticles(mx, my, "red");
                }
            }
        });
    });

    window.onload = () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        initLevel();
        draw();
    };
</script>
</body>
</html>
